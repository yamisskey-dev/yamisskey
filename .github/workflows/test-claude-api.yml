---
name: Test Claude API

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçœç•¥å¯ï¼‰'
        required: false
        default: 'Hello Claude, please respond with a simple greeting.'

jobs:
  test-claude:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Test Claude API Connection
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TEST_MESSAGE: ${{ github.event.inputs.test_message }}
        run: |
          echo "Testing Claude API with new key..."
          echo "API Key available: ${ANTHROPIC_API_KEY:+YES}"
          echo "API Key prefix: ${ANTHROPIC_API_KEY:0:20}..."
          
          # ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          TEST_PROMPT="${TEST_MESSAGE:-Hello Claude, please respond with a simple greeting in Japanese.}"
          
          # Claude APIãƒ†ã‚¹ãƒˆ
          API_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" -X POST "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-3-5-sonnet-20241022\",
              \"max_tokens\": 100,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": \"$TEST_PROMPT\"
                }
              ]
            }")
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
          HTTP_STATUS=$(echo "$API_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          API_BODY=$(echo "$API_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… SUCCESS: Claude API is working!"
            RESPONSE_TEXT=$(echo "$API_BODY" | jq -r '.content[0].text // "Failed to parse response"')
            echo "Claude Response: $RESPONSE_TEXT"
            echo ""
            echo "ğŸ‰ æ–°ã—ã„APIã‚­ãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼"
            echo "Yamisskeyã®AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨å¯èƒ½ã§ã™ã€‚"
          else
            echo "âŒ FAILED: Claude API test failed"
            echo "Response body: $API_BODY"
            ERROR_MSG=$(echo "$API_BODY" | jq -r '.error.message // "Unknown error"')
            echo "Error: $ERROR_MSG"
            echo ""
            echo "ğŸ”§ APIã‚­ãƒ¼ã®ç¢ºèªãŒå¿…è¦ã§ã™:"
            echo "1. GitHub Secrets ã® ANTHROPIC_API_KEY ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹"
            echo "2. APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã§æœŸé™åˆ‡ã‚Œã§ãªã„ã‹"
            echo "3. Claude Console ã§APIã‚­ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª"
            exit 1
          fi