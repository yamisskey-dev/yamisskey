<!--
SPDX-FileCopyrightText: syuilo and misskey-project
SPDX-License-Identifier: AGPL-3.0-only
-->

<template>
<XColumn :menu="menu" :column="column" :isStacked="isStacked" :refresher="async () => { await timeline?.reloadTimeline() }">
	<template #header>
		<i v-if="column.tl != null" :class="basicTimelineIconClass(column.tl)"/>
		<span style="margin-left: 8px;">{{ column.name || (column.tl ? i18n.ts._timelines[column.tl] : null) || i18n.ts._deck._columns.tl }}</span>
	</template>

	<div v-if="!isAvailableBasicTimeline(column.tl)" :class="$style.disabled">
		<p :class="$style.disabledTitle">
			<i class="ti ti-circle-minus"></i>
			{{ i18n.ts._disabledTimeline.title }}
		</p>
		<p :class="$style.disabledDescription">{{ i18n.ts._disabledTimeline.description }}</p>
	</div>
	<MkStreamingNotesTimeline
		v-else-if="column.tl"
		ref="timeline"
		:key="column.tl + withRenotes + withReplies + onlyFiles + localOnly + remoteOnly + withHashtags + excludeBots + showYamiNonFollowingPublicNotes + showYamiFollowingNotes"
		:src="column.tl"
		:withRenotes="withRenotes"
		:withReplies="withReplies"
		:withSensitive="withSensitive"
		:onlyFiles="onlyFiles"
		:localOnly="localOnly"
		:remoteOnly="remoteOnly"
		:withHashtags="withHashtags"
		:excludeBots="excludeBots"
		:showYamiNonFollowingPublicNotes="showYamiNonFollowingPublicNotes"
		:showYamiFollowingNotes="showYamiFollowingNotes"
		:sound="true"
		:customSound="soundSetting"
	/>
</XColumn>
</template>

<script lang="ts" setup>
import { onMounted, watch, ref, useTemplateRef, computed } from 'vue';
import XColumn from './column.vue';
import type { Column } from '@/deck.js';
import type { MenuItem } from '@/types/menu.js';
import type { SoundStore } from '@/preferences/def.js';
import { removeColumn, updateColumn } from '@/deck.js';
import MkStreamingNotesTimeline from '@/components/MkStreamingNotesTimeline.vue';
import * as os from '@/os.js';
import { i18n } from '@/i18n.js';
import { hasWithReplies, isAvailableBasicTimeline, basicTimelineIconClass } from '@/timelines.js';
import { soundSettingsButton } from '@/ui/deck/tl-note-notification.js';

const props = defineProps<{
	column: Column;
	isStacked: boolean;
}>();

const timeline = useTemplateRef('timeline');

const soundSetting = ref<SoundStore>(props.column.soundSetting ?? { type: null, volume: 1 });
const withRenotes = ref(props.column.withRenotes ?? true);
const withReplies = ref(props.column.withReplies ?? false);
const withSensitive = ref(props.column.withSensitive ?? true);
const onlyFiles = ref(props.column.onlyFiles ?? false);
const localOnly = ref(props.column.localOnly ?? false);
const remoteOnly = ref(props.column.remoteOnly ?? false);
const withHashtags = ref(props.column.withHashtags ?? false);
const excludeBots = ref(props.column.excludeBots ?? false);
const showYamiNonFollowingPublicNotes = ref(props.column.showYamiNonFollowingPublicNotes ?? false);
const showYamiFollowingNotes = ref(props.column.showYamiFollowingNotes ?? false);

watch(withRenotes, v => {
	updateColumn(props.column.id, {
		withRenotes: v,
	});
});

watch(withReplies, v => {
	updateColumn(props.column.id, {
		withReplies: v,
	});
});

watch(withSensitive, v => {
	updateColumn(props.column.id, {
		withSensitive: v,
	});
});

watch(onlyFiles, v => {
	updateColumn(props.column.id, {
		onlyFiles: v,
	});
});

watch(soundSetting, v => {
	updateColumn(props.column.id, { soundSetting: v });
});

watch(showYamiNonFollowingPublicNotes, v => {
	updateColumn(props.column.id, {
		showYamiNonFollowingPublicNotes: v,
	});
});

watch(showYamiFollowingNotes, v => {
	updateColumn(props.column.id, {
		showYamiFollowingNotes: v,
	});
});

watch(localOnly, v => {
	updateColumn(props.column.id, {
		localOnly: v,
	});
});

watch(remoteOnly, v => {
	updateColumn(props.column.id, {
		remoteOnly: v,
	});
});

watch(withHashtags, v => {
	updateColumn(props.column.id, {
		withHashtags: v,
	});
});

watch(excludeBots, v => {
	updateColumn(props.column.id, {
		excludeBots: v,
	});
});

onMounted(() => {
	if (props.column.tl == null) {
		setType();
	}
});

async function setType() {
	const { canceled, result: src } = await os.select({
		title: i18n.ts.timeline,
		items: [{
			value: 'home' as const, text: i18n.ts._timelines.home,
		}, {
			value: 'yami' as const, text: i18n.ts._timelines.yami,
		}, {
			value: 'local' as const, text: i18n.ts._timelines.local,
		}, {
			value: 'social' as const, text: i18n.ts._timelines.social,
		}, {
			value: 'global' as const, text: i18n.ts._timelines.global,
		}],
	});
	if (canceled) {
		if (props.column.tl == null) {
			removeColumn(props.column.id);
		}
		return;
	}
	if (src == null) return;
	updateColumn(props.column.id, {
		tl: src ?? undefined,
	});
}

const menu = computed<MenuItem[]>(() => {
	const menuItems: MenuItem[] = [];

	menuItems.push({
		icon: 'ti ti-pencil',
		text: i18n.ts.timeline,
		action: setType,
	}, {
		icon: 'ti ti-bell',
		text: i18n.ts._deck.newNoteNotificationSettings,
		action: () => soundSettingsButton(soundSetting),
	}, {
		type: 'switch',
		text: i18n.ts.showRenotes,
		ref: withRenotes,
	});

	if (hasWithReplies(props.column.tl)) {
		menuItems.push({
			type: 'switch',
			text: i18n.ts.showRepliesToOthersInTimeline,
			ref: withReplies,
			disabled: onlyFiles,
		});
	}

	menuItems.push({
		type: 'switch',
		text: i18n.ts.fileAttachedOnly,
		ref: onlyFiles,
		disabled: hasWithReplies(props.column.tl) ? withReplies : false,
	}, {
		type: 'switch',
		text: i18n.ts.withSensitive,
		ref: withSensitive,
	});

	// 全タイムラインでBotフィルター
	if (['home', 'local', 'social', 'global', 'yami'].includes(props.column.tl ?? '')) {
		menuItems.push({
			type: 'switch',
			text: i18n.ts.timelineExcludeBots,
			ref: excludeBots,
		});
	}

	// socialタイムライン専用オプション
	if (props.column.tl === 'social') {
		menuItems.push({
			type: 'switch',
			text: i18n.ts.localOnly,
			ref: localOnly,
		});
	}

	// globalタイムライン専用オプション
	if (props.column.tl === 'global') {
		menuItems.push({
			type: 'switch',
			text: i18n.ts.remoteOnly,
			ref: remoteOnly,
		}, {
			type: 'switch',
			text: i18n.ts.withHashtags,
			ref: withHashtags,
		});
	}

	// yamiタイムライン専用オプション
	if (props.column.tl === 'yami') {
		menuItems.push({
			type: 'switch',
			text: i18n.ts.localOnly,
			ref: localOnly,
		}, {
			type: 'switch',
			text: i18n.ts._yami.showYamiNonFollowingPublicNotes,
			ref: showYamiNonFollowingPublicNotes,
		}, {
			type: 'switch',
			text: i18n.ts._yami.showYamiFollowingNotes,
			ref: showYamiFollowingNotes,
		});
	}

	return menuItems;
});
</script>

<style lang="scss" module>
.disabled {
	text-align: center;
}

.disabledTitle {
	margin: 16px;
}

.disabledDescription {
	font-size: 90%;
}
</style>
