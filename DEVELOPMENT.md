# yamisskey 開発ガイド

![yamisskeyプロジェクトアイコン](https://github.com/yamisskey-dev/yamisskey-assets/blob/main/yamisskey/yamisskey_project.png?raw=true)

## 概要

このドキュメントは、yamisskey 開発チームメンバー向けの技術手順書です。

> [!NOTE]
> 開発への参加を希望される方は、まずプロジェクト管理者にご連絡ください。

[Misskey](https://github.com/misskey-dev/misskey) フォーク「[yamisskey](https://github.com/yamisskey-dev/yamisskey/)」の開発手順を説明します。基本的な開発手順は[フォーク元の開発ガイド](https://github.com/misskey-dev/misskey/blob/develop/CONTRIBUTING.md#development)を参照してください。

## ブランチとバージョン

yamisskey は 3ブランチで開発を進めます：

| ブランチ | 環境 | バージョン形式 | 用途 |
|---------|------|---------------|------|
| **muyami** | 開発（ローカル） | `2025.1.0-muyami-1.4.3` | 新機能開発・実験的機能 |
| **nayami** | テスト（[なやみすきー](https://na.yami.ski/)） | `2025.1.0-nayami-1.4.3` | 本番前検証（push時にDockerイメージ自動ビルド） |
| **master** | 本番（[やみすきー](https://yami.ski/)） | `2025.1.0-yami-1.4.3` | 安定運用版（リリース時にDockerイメージ自動ビルド） |

**開発の流れ**: muyami → nayami → master

**重要**: すべての変更は**必ずmuyamiブランチから開始**してください。nayamiやmasterで直接開発することは禁止です。

## 開発環境

### 必要な環境
- Node.js（LTS版推奨）
- pnpm
- Git 2.5+
- Docker & Docker Compose（Dev Container用、推奨）

### 推奨エディタ
- VSCode 1.103+（Dev Container対応）
- その他のエディタも使用可能

## セットアップ

### 1. リポジトリのクローン

```bash
git clone https://github.com/yamisskey-dev/yamisskey.git
cd yamisskey

# リモート設定
git remote add upstream https://github.com/misskey-dev/misskey.git
git fetch --all --prune --tags
```

### 2. 開発ブランチに切り替え

```bash
git checkout muyami
```

### 3. 依存関係のインストール

```bash
pnpm install
pnpm build
pnpm build-misskey-js-with-types
```

## 開発フロー

### 日常的な開発作業

**重要**: 開発は必ずmuyamiブランチで行います。

```bash
# muyamiブランチに切り替え
git checkout muyami

# トピックブランチで開発
git checkout -b feat/新機能名

# 開発・テスト
pnpm dev

# コミット
git add .
git commit -m "feat: 新機能の実装"

# muyamiにマージしてプッシュ
git checkout muyami
git merge feat/新機能名
git push origin muyami
```

### テスト環境への反映

```bash
# nayamiブランチに切り替え
git checkout nayami
git pull origin nayami
git merge muyami

# package.jsonのバージョン更新（muyami → nayami）
# 例: 2025.1.0-muyami-1.4.3 → 2025.1.0-nayami-1.4.3

git push origin nayami  # Dockerイメージが自動ビルドされる
```

[なやみすきー](https://na.yami.ski/)で動作確認後、本番への反映を進めます。

### 本番環境への反映

```bash
# masterブランチに切り替え
git checkout master
git pull origin master
git merge nayami

# package.jsonのバージョン更新（nayami → yami）
# 例: 2025.1.0-nayami-1.4.3 → 2025.1.0-yami-1.4.3

git push origin master
```

**リリース手順**:
1. `DIFFERENCE.md` の Unreleased 項目に変更点を記載
2. `package.json` の version をインクリメント
3. GitHub で [Release Manager Dispatch](https://github.com/yamisskey-dev/yamisskey/actions/workflows/release-with-dispatch.yml) を実行
4. 自動生成された PR で `package.json` のバージョンを yami 形式に修正
5. PR をマージすると GitHub Release と Docker イメージが自動生成

## 応用的な使い方

### git worktreeを使った並列開発

複数の機能を同時開発する場合、git worktreeを使用できます：

```bash
# メインリポジトリで作業
cd yamisskey

# 並列開発用のworktreeを作成（muyamiベース）
git worktree add ../yamisskey-feat-a -b feat/feature-a muyami
git worktree add ../yamisskey-feat-b -b feat/feature-b muyami

# 各worktreeで開発
cd ../yamisskey-feat-a
pnpm install && pnpm build
# 開発作業...

cd ../yamisskey-feat-b
pnpm install && pnpm build
# 開発作業...

# 開発完了後、muyamiにマージ
cd ../yamisskey
git checkout muyami
git merge feat/feature-a
git merge feat/feature-b
git push origin muyami

# worktreeの削除
git worktree remove ../yamisskey-feat-a
git worktree remove ../yamisskey-feat-b
```

### アップストリームからの変更取り込み

```bash
# バックアップを作成
git checkout muyami
VERSION=$(node -p "require('./package.json').version")
git branch backup/$VERSION

git checkout nayami
VERSION=$(node -p "require('./package.json').version")
git branch backup/$VERSION

git checkout master
VERSION=$(node -p "require('./package.json').version")
git branch backup/$VERSION

# muyamiに取り込み
git checkout muyami
git fetch upstream --tags --prune
git merge --no-ff --no-edit -S <tag-name>

# コンフリクト解決後
git add -A
git commit -m "upstream: resolve conflicts for <tag-name>"

# nayami → master へ順次反映
```

### 他フォークからのcherry-pick

```bash
# 他フォークをリモートに追加
git remote add cherrypick https://github.com/kokonect-link/cherrypick.git
git fetch cherrypick

# コミットIDを確認
git log cherrypick/develop --oneline -20

# muyamiにcherry-pick
git checkout muyami
git cherry-pick <コミットID>
```

## トラブルシューティング

```bash
# ブランチの状態を確認
git status
git log --oneline -10

# マージの中断
git merge --abort

# バックアップからの復元
git checkout muyami
git reset --hard backup/2025.1.0-muyami-1.4.3
git push --force origin muyami  # 注意：慎重に実行

# worktreeのクリーンアップ
git worktree prune

# 権限エラー
sudo chown -R $(whoami) yamisskey/
```

## 開発ルール

- **すべての開発はmuyamiから開始**（nayami/masterでの直接開発は禁止）
- トピックブランチで開発し、muyamiにマージ
- muyami → nayami → master の順で反映（逆順禁止）
- 重要な変更前は必ずバックアップを作成
- プライバシー・セキュリティ機能は特に慎重にテスト

## CI/CDとAI活用

### GitHub Actions
- コード品質保証（リント、型チェック）
- 自動テスト実行とビルドエラー検出
- 本番環境への安全なデプロイ

### AI活用
- Dev Containerに各種AIツールを統合可能
- PR レビュー: Claude と Gemini による自動コードレビュー
- 生成コードは必ず人間がレビュー
- セキュリティ・プライバシー関連は適切性を必ず確認
